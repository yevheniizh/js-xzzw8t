<!-- Inspired by the visuals of https://ykob.github.io/sketch-threejs/ -->
<!-- Inspired by the idea of https://podcast.adobe.com/enhance -->
<!-- Audio+ThreeJS https://youtu.be/tQL1VLTJTnc -->
<!-- Post-processing https://blog.maximeheckel.com/posts/vaporwave-3d-scene-with-threejs/ -->

<div id="container">
  <div class="play-pause-button">
    <input type="checkbox" id="play-pause-toggler" style="opacity:0;position:absolute;inset: 0;">
    <div class="checkbox play-checkbox"></div>
  </div>
  <div class="strength-button-container">
    <input type="checkbox" id="audio-enhancer-toggler" style="opacity:0;position:absolute;inset: 0;">
    <div class="checkbox audio-enhancer-toggler"></div>
  </div>
  <div id="audio-progress-bar-container"></div>
</div>

<style>
  .play-pause-button {
    position: relative;
  }

  .checkbox {
    border: 1px solid #ccc;
  }

  #container {
    width: 30rem;
    color: #fff;
    border-radius: 0.5rem;
    padding-left: 0;
    padding-right: 0;
    display: flex;
    gap: 1rem;
    position: absolute;
    bottom: 0%;
    left: 50%;
    right: auto;
    transform: translate(-50%, -50%);
    background-color: rgba(29, 29, 29, .85);
    border: 1px solid #646464;
    padding: 1rem;
    justify-content: space-between;
    align-items: center;
  }

  .player-button {
    opacity: 1;
    background-color: rgba(95, 95, 95, .5);
    background-image: url("https://assets-global.website-files.com/650bfe21db0140abe3b9f6c2/650ca737c7620e388150e3fb_play.svg");
    background-position: 50%;
    background-repeat: no-repeat;
    background-size: auto;
    border: 1px solid rgba(147, 147, 147, .8);
    border-radius: 22px;
  }

  .player-button.playing {
    background-image: url("https://assets-global.website-files.com/650bfe21db0140abe3b9f6c2/650cae6675c5ad4065d76a0a_pause.svg");
    background-position: 50%;
    background-size: auto;
  }

  #play-pause-toggler + .play-checkbox {
    pointer-events: none;
    width: 3.5rem;
    height: 3.5rem;
    background-color: rgba(95, 95, 95, 0);
    background-image: url("https://assets-global.website-files.com/650bfe21db0140abe3b9f6c2/650ca737c7620e388150e3fb_play.svg");
    background-position: 50%;
    background-repeat: no-repeat;
    background-size: 1rem;
    border-color: rgba(255, 255, 255, .8);
    border-radius: 50%;
  }

  #play-pause-toggler:checked + .play-checkbox {
    background-image: url("https://assets-global.website-files.com/650bfe21db0140abe3b9f6c2/650cae6675c5ad4065d76a0a_pause.svg");
  }

  .strength-button-container {
    position: relative;
    width: 4rem;
    height: 2rem;
  }

  #audio-enhancer-toggler + .audio-enhancer-toggler {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    background-image: url("https://assets-global.website-files.com/650bfe21db0140abe3b9f6c2/650c37b20529318319244cf9_ellipse.svg");
    background-position: 0.2rem;
    background-repeat: no-repeat;
    background-size: 1.6rem 1.6rem;
    border-radius: 2rem;
    transition: background-position .1s linear;
    pointer-events: none;
  }

  #audio-enhancer-toggler:checked + .audio-enhancer-toggler {
    background-position: 2.25rem;
    background-color: #9671ff;
  }

  #audio-progress-bar-container {
    flex: 1;
  }
</style>

<!-- TO BE MIGRATED TO THE WEBFLOW -->

<style>
  #play-pause-toggler + span, #audio-enhancer-toggler + span {
    user-select: none;
  }
  #audio-progress-bar-container {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  input[type='range'] {
    overflow: hidden;
    width: 100%;
    -webkit-appearance: none;
    background-color: rgb(214 215 216);
    border-radius: 3px;
  }
  input[type='range']::-webkit-slider-runnable-track {
    height: 6px;
    -webkit-appearance: none;
    margin-top: -1px;
    cursor: pointer;
  }
  input[type='range']::-webkit-slider-thumb {
    width: 6px;
    -webkit-appearance: none;
    height: 6px;
    background: transparent;
    box-shadow: -1000px 0 0 1000px rgb(139 115 239);
  }
  input[type="range"]::-moz-range-progress {
    background-color: rgb(139 115 239); 
  }
  input[type="range"]::-moz-range-track {  
    background-color: rgb(214 215 216);
  }
  input[type="range"]::-ms-fill-lower {
    background-color: rgb(139 115 239); 
  }
  input[type="range"]::-ms-fill-upper {  
    background-color: rgb(214 215 216);
  }
</style>

<canvas id="webgl" style="position: absolute; inset: 0; z-index: -1"></canvas>

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
    }
  }
</script>

<script type="module" >  
  window.vertexShader = `
    varying vec2 vUv;
    varying vec3 vPosition;
    varying float x;
    varying float y;
    varying float z;
    uniform float[64] tAudioData;

    uniform float uTime;
    uniform float uWavesElevation;
    uniform float uWavesSpeed;
    varying float vElevation;

    void main() {
      vUv = uv;
      vPosition = position;

      x = abs(position.x);
      y = abs(position.y);

      float floor_x = round(x);
      float floor_y = round(y);

      float intensity = 0.4;
      z = sin(tAudioData[int(floor_x)] / 32.0 + tAudioData[int(floor_y)] / 32.0) * intensity;

      float sin1 = sin((position.x + position.y) * 0.2 + uTime * uWavesSpeed);
      float sin2 = sin((position.x - position.y) * 0.2 + uTime * uWavesSpeed);
      float sin3 = sin((position.x + position.y) * -0.15 + uTime * uWavesSpeed);

      vec3 updatePosition = vec3(position.x, position.y, z);

      vec4 modelPosition = modelMatrix * vec4(updatePosition, 1.0);

      float elevation = sin1 * sin2 * sin3 * uWavesElevation;

      modelPosition.y += elevation;

      gl_Position = projectionMatrix * viewMatrix * modelPosition;
      
      // Varyings
      vElevation = elevation;
    }`;
  window.fragmentShader = `
    varying vec2 vUv;
    varying vec3 vPosition;
    uniform float uTime;
    uniform float uStartTime; 
    const float duration = 2.0;
    const float delay = 0.0;
    uniform bool uAudioEnhanced;
    uniform bool uAudioEnhancedInitially;

    uniform vec3 uDepthColor;
    uniform vec3 uSurfaceColor;
    varying float vElevation;

    // note: (sqrt(pow(p.x, 2.0) + pow(p-y, 2.0)) - Ð³);
    float sdfCircle(vec2 p, float r) {
      return length(p) - r;
    }

    void main() {
      // Initial appearing
      float now = clamp((uTime - delay) / duration, 0.1, 1.0);
      float opacity = (1.0 - length(vPosition.xy / vec2(32.0))) * now;

      // Time
      float speed = 0.5;
      float w = clamp((uTime-uStartTime) / speed, 0., 1.);
      w = mix(float(uAudioEnhancedInitially) * 1.0-w, w, float(uAudioEnhanced));

      // Colors
      vec3 defaultColor = mix(uDepthColor, uSurfaceColor, vElevation * 1.75 + 0.75);
      vec3 enhancedColor = vec3(vUv, 1.0);

      // Define the animation speed
      float radius = 16.0 * w;
      float distance = sdfCircle( vPosition.xy, radius );

      // Calculate the gradient based on the distance from the center
      vec3 gradientColor = mix(enhancedColor, defaultColor, step(radius, distance));
    
      // Set the fragment color
      gl_FragColor = vec4(gradientColor, opacity);
    }`;
</script>

<script type="module" src="./index.js"></script>